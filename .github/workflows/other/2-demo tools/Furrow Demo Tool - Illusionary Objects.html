<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Furrow Illusion (Split Angles) + Kanizsa ‚Äî Controls</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0e1117;
            --panel: #141a24;
            --ink: #e6edf7;
            --muted: #9aa3b2;
            --edge: #2a3345;
            --accent: #7bd88f;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }

        .page {
            height: 100%;
            display: grid;
            place-items: center;
            padding: 12px;
        }

        .shell {
            display: grid;
            grid-template-columns: minmax(320px, 520px) 320px;
            gap: 10px;
            align-items: start;
        }

        .card {
            background: linear-gradient(180deg, #161c27, #111620);
            border: 1px solid var(--edge);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .04);
        }

        .canvasCard {
            padding: 8px;
        }

        canvas {
            background: transparent;
            display: block;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .panel {
            padding: 10px 12px;
        }

        h1 {
            font-size: 15px;
            margin: 0 0 8px 0;
            letter-spacing: .2px;
        }

        .group {
            border-top: 1px dashed #253049;
            padding-top: 8px;
            margin-top: 8px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
            margin: 6px 0;
        }

        label {
            color: var(--muted);
        }

        input[type="range"],
        select {
            width: 170px;
        }

        .val {
            color: var(--muted);
            min-width: 48px;
            text-align: right;
        }

        .btns {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        button {
            background: #0f1422;
            border: 1px solid var(--edge);
            color: var(--ink);
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            border-color: #3a4460;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
            margin-top: 6px;
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="shell">
            <div class="card canvasCard">
                <canvas id="cv" width="520" height="520" aria-label="Furrow + Kanizsa"></canvas>
            </div>

            <div class="card panel">
                <div style="display:flex;align-items:baseline;justify-content:space-between;">
                    <h1>Controls</h1>
                    <div class="btns">
                        <button id="shapeBtn">Square</button>
                        <button id="pauseBtn">Pause</button>
                        <button id="resetBtn">Reset</button>
                    </div>
                </div>

                <div class="group">
                    <div class="row">
                        <label for="angleL">Left stripe angle (¬∞)</label>
                        <div><input id="angleL" type="range" min="-85" max="85" step="1" value="-45">
                            <span class="val" id="angleLVal">45¬∞</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="angleR">Right stripe angle (¬∞)</label>
                        <div><input id="angleR" type="range" min="-85" max="85" step="1" value="45">
                            <span class="val" id="angleRVal">45¬∞</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="period">Stripe frequency (px / cycle)</label>
                        <div><input id="period" type="range" min="6" max="80" step="2" value="20">
                            <span class="val" id="periodVal">20</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="contrast">Stripe contrast</label>
                        <div><input id="contrast" type="range" min="0" max="100" step="1" value="85">
                            <span class="val" id="contrastVal">0.85</span>
                        </div>
                    </div>
                </div>

                <div class="group">
                    <div class="row">
                        <label for="speed">Object speed (px/s)</label>
                        <div><input id="speed" type="range" min="0" max="400" step="5" value="120">
                            <span class="val" id="speedVal">120</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="range">Motion range (px)</label>
                        <div><input id="range" type="range" min="60" max="240" step="5" value="150">
                            <span class="val" id="rangeVal">150</span>
                        </div>
                    </div>
                </div>

                <div class="group">
                    <div class="row">
                        <label for="size">Implied square/triangle size (px)</label>
                        <div><input id="size" type="range" min="30" max="240" step="2" value="70">
                            <span class="val" id="sizeVal">70</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="arm">L-arm length (px)</label>
                        <div><input id="arm" type="range" min="5" max="150" step="1" value="15">
                            <span class="val" id="armVal">15</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="thick">L thickness (px)</label>
                        <div><input id="thick" type="range" min="2" max="60" step="1" value="5">
                            <span class="val" id="thickVal">5</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="icolor">Figure Color (black‚Üíwhite)</label>
                        <div><input id="icolor" type="range" min="0" max="255" step="1" value="128">
                            <span class="val" id="icolorVal">#808080</span>
                        </div>
                    </div>
                    <div class="row">
                        <label for="pacmode">Triangle inducers</label>
                        <div>
                            <select id="pacmode">
                                <option value="all">All 3</option>
                                <option value="sides">Left + Right only</option>
                                <option value="top">Top only</option> <!-- üëà add this -->
                            </select>

                        </div>
                    </div>
                </div>

                <div class="hint">Tip: Toggle ‚ÄúTriangle‚Äù for the Kanizsa triangle (Pac-Man inducers).</div>
            </div>
        </div>
    </div>

    <script>
        const cv = document.getElementById('cv');
        const cx = cv.getContext('2d');

        const ui = {
            angleL: document.getElementById('angleL'),
            angleR: document.getElementById('angleR'),
            period: document.getElementById('period'),
            contrast: document.getElementById('contrast'),
            speed: document.getElementById('speed'),
            range: document.getElementById('range'),
            size: document.getElementById('size'),
            arm: document.getElementById('arm'),
            thick: document.getElementById('thick'),
            icolor: document.getElementById('icolor'),
            pacmode: document.getElementById('pacmode'),
            pauseBtn: document.getElementById('pauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            shapeBtn: document.getElementById('shapeBtn'),
        };
        const lab = {
            angleL: document.getElementById('angleLVal'),
            angleR: document.getElementById('angleRVal'),
            period: document.getElementById('periodVal'),
            contrast: document.getElementById('contrastVal'),
            speed: document.getElementById('speedVal'),
            range: document.getElementById('rangeVal'),
            size: document.getElementById('sizeVal'),
            arm: document.getElementById('armVal'),
            thick: document.getElementById('thickVal'),
            icolor: document.getElementById('icolorVal'),
        };

        let running = true;
        let y = cv.height / 2;
        let dir = 1;
        let lastT = performance.now();
        let shape = 'triangle';

        const tile = document.createElement('canvas');
        const tctx = tile.getContext('2d');

        function buildStripeTile(periodPx, contrast01) {
            const size = Math.max(64, periodPx * 4);
            tile.width = size; tile.height = size;
            tctx.clearRect(0, 0, size, size);
            const hi = Math.round(contrast01 * 255);
            const lo = 0;
            for (let yy = 0; yy < size; yy += periodPx) {
                tctx.fillStyle = `rgb(${hi},${hi},${hi})`;
                tctx.fillRect(0, yy, size, periodPx / 2);
                tctx.fillStyle = `rgb(${lo},${lo},${lo})`;
                tctx.fillRect(0, yy + periodPx / 2, size, periodPx / 2);
            }
        }
        buildStripeTile(+ui.period.value, +ui.contrast.value / 100);

        function params() {
            return {
                angleL: +ui.angleL.value,
                angleR: +ui.angleR.value,
                period: +ui.period.value,
                contrast: +ui.contrast.value / 100,
                speed: +ui.speed.value,
                range: +ui.range.value,
                illusSide: +ui.size.value,
                armLength: +ui.arm.value,
                armThickness: +ui.thick.value,
                colorGray: +ui.icolor.value,
                pacmode: ui.pacmode.value
            };
        }

        function drawHalfStripes(angleDeg, side) {
            const pattern = cx.createPattern(tile, 'repeat');
            cx.save();
            if (side === 'left') {
                cx.beginPath();
                cx.rect(0, 0, cv.width / 2, cv.height);
                cx.clip();
            } else {
                cx.beginPath();
                cx.rect(cv.width / 2, 0, cv.width / 2, cv.height);
                cx.clip();
            }
            cx.translate(cv.width / 2, cv.height / 2);
            cx.rotate(angleDeg * Math.PI / 180);
            cx.translate(-cv.width / 2, -cv.height / 2);
            cx.fillStyle = pattern;
            cx.fillRect(-cv.width, -cv.height, cv.width * 3, cv.height * 3);
            cx.restore();
        }

        function drawLCorner(x, y, arm, th, orientation, color) {
            cx.fillStyle = color;
            switch (orientation) {
                case 'TL': cx.fillRect(x - arm, y - th, arm, th); cx.fillRect(x - th, y - arm, th, arm); break;
                case 'TR': cx.fillRect(x, y - th, arm, th); cx.fillRect(x, y - arm, th, arm); break;
                case 'BR': cx.fillRect(x, y, arm, th); cx.fillRect(x, y, th, arm); break;
                case 'BL': cx.fillRect(x - arm, y, arm, th); cx.fillRect(x - th, y, th, arm); break;
            }
        }
        function drawKanizsaSquare(cx0, cy0, side, arm, th, color) {
            const h = side / 2;
            drawLCorner(cx0 + h, cy0 + h, arm, th, 'TL', color);
            drawLCorner(cx0 - h, cy0 + h, arm, th, 'TR', color);
            drawLCorner(cx0 - h, cy0 - h, arm, th, 'BR', color);
            drawLCorner(cx0 + h, cy0 - h, arm, th, 'BL', color);
        }

        function drawPacman(x, y, r, theta, color, aperture = Math.PI / 2) {
            cx.save();
            cx.fillStyle = color;
            const start = theta + aperture / 2;
            const end = theta - aperture / 2;
            cx.beginPath();
            cx.moveTo(x, y);
            cx.arc(x, y, r, start, end);
            cx.closePath();
            cx.fill();
            cx.restore();
        }

        function drawKanizsaTriangle(cx0, cy0, side, radius, color, mode) {
            const R = side / Math.sqrt(3);
            const angs = [-Math.PI / 2, Math.PI / 6, 5 * Math.PI / 6];
            const verts = angs.map(a => ({ x: cx0 + R * Math.cos(a), y: cy0 + R * Math.sin(a) }));

            verts.forEach((v, i) => {
                if (mode === "sides" && i === 0) return;       // skip top
                if (mode === "top" && i !== 0) return;         // only top
                const theta = Math.atan2(cy0 - v.y, cx0 - v.x);
                drawPacman(v.x, v.y, radius, theta, color, Math.PI / 2);
            });

        }

        function loop(t) {
            const dt = Math.min(0.05, (t - lastT) / 1000);
            lastT = t;

            const P = params();

            if (running) {
                const center = cv.height / 2;
                const halfRange = P.range / 2;
                y += dir * P.speed * dt;
                if (y > center + halfRange) { y = center + halfRange; dir = -1; }
                if (y < center - halfRange) { y = center - halfRange; dir = 1; }
            }

            cx.clearRect(0, 0, cv.width, cv.height);

            drawHalfStripes(P.angleL, 'left');
            drawHalfStripes(P.angleR, 'right');

            const g = P.colorGray | 0;
            const color = `rgb(${g},${g},${g})`;

            if (shape === 'square') {
                drawKanizsaSquare(cv.width / 2, y, P.illusSide, P.armLength, P.armThickness, color);
            } else {
                const r = Math.max(8, Math.min(P.illusSide / 3, P.armLength + P.armThickness));
                drawKanizsaTriangle(cv.width / 2, y, P.illusSide, r, color, P.pacmode);
            }

            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

        function syncLabels() {
            lab.angleL.textContent = `${ui.angleL.value}¬∞`;
            lab.angleR.textContent = `${ui.angleR.value}¬∞`;
            lab.period.textContent = ui.period.value;
            lab.contrast.textContent = (+ui.contrast.value / 100).toFixed(2);
            lab.speed.textContent = ui.speed.value;
            lab.range.textContent = ui.range.value;
            lab.size.textContent = ui.size.value;
            lab.arm.textContent = ui.arm.value;
            lab.thick.textContent = ui.thick.value;
            const g = (+ui.icolor.value) | 0;
            const hex = '#' + g.toString(16).padStart(2, '0').repeat(3);
            lab.icolor.textContent = hex;
        }

        ['angleL', 'angleR', 'period', 'contrast', 'speed', 'range', 'size', 'arm', 'thick', 'icolor', 'pacmode']
            .forEach(id => {
                ui[id].addEventListener('input', () => {
                    if (id === 'period' || id === 'contrast') {
                        buildStripeTile(+ui.period.value, +ui.contrast.value / 100);
                    }
                    syncLabels();
                });
            });
        syncLabels();

        ui.pauseBtn.addEventListener('click', () => {
            running = !running;
            ui.pauseBtn.textContent = running ? 'Pause' : 'Resume';
        });

        ui.resetBtn.addEventListener('click', () => {
            ui.angleL.value = -45; ui.angleR.value = 45;
            ui.period.value = 20; ui.contrast.value = 85;
            ui.speed.value = 120; ui.range.value = 150;
            ui.size.value = 70; ui.arm.value = 15; ui.thick.value = 5; ui.icolor.value = 128;
            ui.pacmode.value = "all";
            buildStripeTile(+ui.period.value, +ui.contrast.value / 100);
            syncLabels();
            y = cv.height / 2; dir = 1; running = true; ui.pauseBtn.textContent = 'Pause';
            shape = 'triangle'; ui.shapeBtn.textContent = 'Square';
        });

        ui.shapeBtn.addEventListener('click', () => {
            shape = (shape === 'square') ? 'triangle' : 'square';
            ui.shapeBtn.textContent = (shape === 'square') ? 'Triangle' : 'Square';
        });
    </script>
</body>

</html>